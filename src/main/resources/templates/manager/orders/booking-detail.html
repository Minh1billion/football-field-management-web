<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/manager :: layout(~{::section})">
<section>
    <div class="container py-3"
         th:with="
           pm=${booking != null && booking.payment != null ? booking.payment.paymentMethod.name() : 'N/A'},
           ps=${booking != null && booking.payment != null ? booking.payment.status.name() : 'N/A'}
         ">

        <!-- Header -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3 class="mb-0">Chi tiết booking</h3>
            <a th:href="@{/manager/orders}" class="btn btn-outline-secondary btn-sm">
                Quay lại
            </a>
        </div>

        <!-- Alerts -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${booking}">
            <!-- Summary cards -->
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="text-muted small mb-1">Mã đặt</div>
                            <div class="fw-semibold" th:text="${booking.bookingCode}">BK-XXXXXX</div>
                            <div class="text-muted small">
                                <i class="bi bi-geo-alt"></i>
                                <span th:text="${booking.field != null ? booking.field.name : '—'}">Tên sân</span>
                            </div>
                            <div class="text-muted small">
                                <i class="bi bi-person"></i>
                                <span th:text="${booking.customer != null ? booking.customer.fullName : 'Khách'}">Khách</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="text-muted small mb-1">Trạng thái</div>
                            <div>
                                <span th:if="${booking.status.name() == 'PENDING'}" class="badge bg-warning text-dark">
                                    <i class="bi bi-hourglass-split"></i> Chờ xác nhận
                                </span>
                                <span th:if="${booking.status.name() == 'CONFIRMED'}" class="badge bg-info text-dark">
                                    <i class="bi bi-patch-check"></i> Đã xác nhận
                                </span>
                                <span th:if="${booking.status.name() == 'COMPLETED'}" class="badge bg-success">
                                    <i class="bi bi-check2-circle"></i> Hoàn thành
                                </span>
                                <span th:if="${booking.status.name() == 'CANCELLED'}" class="badge bg-secondary">
                                    <i class="bi bi-x-circle"></i> Đã hủy
                                </span>
                            </div>
                            <div class="text-muted small mt-1">
                                <i class="bi bi-clock"></i>
                                <span th:text="${#temporals.format(booking.startTime, 'dd/MM/yyyy HH:mm')}">—</span>
                                —
                                <span th:text="${#temporals.format(booking.endTime, 'dd/MM/yyyy HH:mm')}">—</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="text-muted small mb-1">Tổng tiền</div>
                            <div class="h5 mb-0 text-success">
                                <i class="bi bi-cash-coin"></i>
                                <span th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</span>
                            </div>
                            <div class="text-muted small">
                                <i class="bi bi-calendar3"></i>
                                <span th:text="${#temporals.format(booking.startTime, 'dd/MM/yyyy')}">—</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="text-muted small mb-1">Thanh toán</div>
                            <div>
                                <span class="badge bg-outline border text-uppercase"
                                      th:text="${booking.payment != null ? booking.payment.paymentMethod.name() : 'N/A'}">N/A</span>
                            </div>
                            <div class="text-muted small mt-1" th:if="${booking.payment != null}">
                                <i class="bi bi-receipt"></i>
                                <span th:text="${booking.payment.status.name()}">PENDING</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thông tin chi tiết -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-info-circle me-2"></i> Thông tin chi tiết
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="mb-2">
                                <span class="text-muted">Tên sân:</span>
                                <span class="fw-semibold" th:text="${booking.field != null ? booking.field.name : '—'}">—</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Thời gian:</span>
                                <span class="fw-semibold">
                                    <span th:text="${#temporals.format(booking.startTime, 'dd/MM/yyyy HH:mm')}">—</span>
                                    —
                                    <span th:text="${#temporals.format(booking.endTime, 'dd/MM/yyyy HH:mm')}">—</span>
                                </span>
                            </div>
                        </div>
                        <div class="col-12 col-md-6" th:if="${booking.notes != null}">
                            <span class="text-muted d-block">Ghi chú:</span>
                            <div class="border rounded p-2 bg-light" th:text="${booking.notes}">...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Đồ thể thao đã thuê -->
            <div class="card mb-3 shadow-sm" th:if="${booking.bookingSportWears != null and !booking.bookingSportWears.isEmpty()}">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bag-check me-1"></i> Đồ thể thao đã thuê</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-center">Ngày thuê</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-end">Thành tiền</th>
                                <th class="text-center">Trạng thái</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="bsw : ${booking.bookingSportWears}">
                                <td th:text="${bsw.sportWear != null ? bsw.sportWear.name : '—'}">—</td>
                                <td class="text-center" th:text="${bsw.quantity}">—</td>
                                <td class="text-center" th:text="${bsw.rentalDays}">—</td>
                                <td class="text-end"
                                    th:text="${#numbers.formatDecimal(bsw.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0</td>
                                <td class="text-end"
                                    th:text="${#numbers.formatDecimal(bsw.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0</td>
                                <td class="text-center">
                                    <span class="badge"
                                          th:classappend="${bsw.status != null && bsw.status.name() == 'RENTED'} ? 'bg-warning text-dark'
                                                         : (${bsw.status != null && bsw.status.name() == 'RETURNED'} ? 'bg-success'
                                                         : 'bg-secondary')"
                                          th:text="${bsw.status != null ? bsw.status.name() : 'N/A'}">N/A</span>
                                </td>
                            </tr>
                            </tbody>
                            <tfoot class="table-light">
                            <tr>
                                <td colspan="4" class="text-end fw-semibold">Tổng cộng</td>
                                <td class="text-end fw-semibold"
                                    th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0</td>
                                <td></td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="alert alert-info" th:if="${booking.bookingSportWears == null or booking.bookingSportWears.isEmpty()}">
                <i class="bi bi-info-circle"></i> Chưa có đồ thể thao nào được thuê cho booking này.
            </div>

            <!-- Dịch vụ đã đặt -->
            <div class="card mb-3 shadow-sm" th:if="${booking.bookingServices != null and !booking.bookingServices.isEmpty()}">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-gear-wide-connected me-1"></i> Dịch vụ đã đặt</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Tên dịch vụ</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="bs : ${booking.bookingServices}">
                                <td th:text="${bs.service != null ? bs.service.name : '—'}">—</td>
                                <td class="text-center" th:text="${bs.quantity}">—</td>
                                <td class="text-end"
                                    th:text="${#numbers.formatDecimal(bs.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0</td>
                                <td class="text-end"
                                    th:text="${#numbers.formatDecimal(bs.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="alert alert-info" th:if="${booking.bookingServices == null or booking.bookingServices.isEmpty()}">
                <i class="bi bi-info-circle"></i> Chưa có dịch vụ nào được đặt cho booking này.
            </div>

            <!-- Actions theo yêu cầu -->
            <div class="d-flex flex-wrap gap-2 mt-3">

                <a th:href="@{/manager/orders}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Quay lại danh sách
                </a>

                <!-- PENDING: Xác nhận + Hủy -->
                <form data-stay="true" th:if="${booking.status.name() == 'PENDING'}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/confirm'}" method="post">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-info text-dark">
                        <i class="bi bi-patch-check"></i> Xác nhận
                    </button>
                </form>

                <form data-stay="true" th:if="${booking.status.name() == 'PENDING'}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/cancel'}" method="post"
                      onsubmit="return confirm('Hủy booking này?');">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-x-circle"></i> Hủy
                    </button>
                </form>

                <!-- CONFIRMED + CASH/COD/N-A: Hoàn tất + Hủy -->
                <form data-stay="true" th:if="${booking.status.name() == 'CONFIRMED' and (pm == 'CASH' or pm == 'COD' or pm == 'N/A')}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/complete'}" method="post"
                      onsubmit="return confirm('Đánh dấu hoàn tất booking này?');">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Hoàn tất
                    </button>
                </form>

                <form data-stay="true" th:if="${booking.status.name() == 'CONFIRMED' and (pm == 'CASH' or pm == 'COD' or pm == 'N/A')}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/cancel'}" method="post"
                      onsubmit="return confirm('Hủy booking này?');">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-x-circle"></i> Hủy
                    </button>
                </form>

                <!-- CONFIRMED + VNPAY + payment PENDING/PROCESSING: 'Chờ thanh toán' + Hủy -->
                <span th:if="${booking.status.name() == 'CONFIRMED' and pm == 'VNPAY' and (ps == 'PENDING' or ps == 'PROCESSING')}"
                      class="badge bg-warning text-dark align-self-center">
                    <i class="bi bi-hourglass-split"></i> Chờ thanh toán
                </span>

                <form data-stay="true" th:if="${booking.status.name() == 'CONFIRMED' and pm == 'VNPAY' and (ps == 'PENDING' or ps == 'PROCESSING')}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/cancel'}" method="post"
                      onsubmit="return confirm('Hủy booking này?');">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-x-circle"></i> Hủy
                    </button>
                </form>

                <!-- CONFIRMED + VNPAY + payment COMPLETED: Hoàn tất + Hủy -->
                <form data-stay="true" th:if="${booking.status.name() == 'CONFIRMED' and pm == 'VNPAY' and ps == 'COMPLETED'}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/complete'}" method="post"
                      onsubmit="return confirm('Đánh dấu hoàn tất booking này?');">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Hoàn tất
                    </button>
                </form>

                <form data-stay="true" th:if="${booking.status.name() == 'CONFIRMED' and pm == 'VNPAY' and ps == 'COMPLETED'}"
                      th:action="@{'/manager/bookings/' + ${booking.id} + '/cancel'}" method="post"
                      onsubmit="return confirm('Hủy booking này?');">
                    <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-x-circle"></i> Hủy
                    </button>
                </form>
            </div>
        </div>

        <div th:if="${booking == null}" class="alert alert-warning">
            Không tìm thấy dữ liệu booking.
        </div>
    </div>

    <!-- AJAX: ở lại trang sau khi bấm nút -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('form[data-stay="true"]').forEach(form => {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');
            const originalHtml = submitBtn ? submitBtn.innerHTML : null;
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Đang xử lý...';
            }

            try {
              const resp = await fetch(form.action, {
                method: form.method || 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: new FormData(form)
              });

              if (!resp.ok) throw new Error('Request failed with status ' + resp.status);

              // Reload lại để lấy trạng thái mới, vẫn ở trang chi tiết
              window.location.reload();
            } catch (err) {
              console.error(err);
              alert('Có lỗi xảy ra, vui lòng thử lại!');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHtml;
              }
            }
          });
        });
      });
    </script>
</section>
</html>