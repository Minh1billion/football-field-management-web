<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/admin :: layout(~{::content})}">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
</head>
<body>
<div th:fragment="content">
  <h2 class="mb-4">ğŸ“Š Tá»•ng quan há»‡ thá»‘ng</h2>
  <div class="row text-center mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">ğŸ‘¥ Tá»•ng tÃ i khoáº£n</h5>
          <h2 th:text="${totalAccounts ?: 0}">0</h2>
          <small>Táº¥t cáº£ tÃ i khoáº£n trong há»‡ thá»‘ng</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">ğŸ‘¤ NgÆ°á»i dÃ¹ng</h5>
          <h2 th:text="${totalUsers ?: 0}">0</h2>
          <small>TÃ i khoáº£n USER</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-warning text-white">
        <div class="card-body">
          <h5 class="card-title">ğŸ‘¨â€ğŸ’¼ Quáº£n lÃ½</h5>
          <h2 th:text="${totalManagers ?: 0}">0</h2>
          <small>TÃ i khoáº£n MANAGER</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-danger text-white">
        <div class="card-body">
          <h5 class="card-title">ğŸ‘‘ Quáº£n trá»‹</h5>
          <h2 th:text="${totalAdmins ?: 0}">0</h2>
          <small>TÃ i khoáº£n ADMIN</small>
        </div>
      </div>
    </div>
  </div>
  <div class="row text-center mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">ğŸŸï¸ SÃ¢n hoáº¡t Ä‘á»™ng</h5>
          <h2 th:text="${totalFields ?: 0}">0</h2>
          <small>SÃ¢n Ä‘ang má»Ÿ</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-secondary text-white">
        <div class="card-body">
          <h5 class="card-title">ğŸ¢ Tá»•ng dá»‹ch vá»¥</h5>
          <h2 th:text="${totalServices ?: 0}">0</h2>
          <small>Táº¥t cáº£ dá»‹ch vá»¥</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">âœ… TK hoáº¡t Ä‘á»™ng</h5>
          <h2 th:text="${activeAccounts ?: 0}">0</h2>
          <small>TÃ i khoáº£n Ä‘ang hoáº¡t Ä‘á»™ng</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-dark text-white">
        <div class="card-body">
          <h5 class="card-title">âŒ TK bá»‹ khÃ³a</h5>
          <h2 th:text="${inactiveAccounts ?: 0}">0</h2>
          <small>TÃ i khoáº£n bá»‹ vÃ´ hiá»‡u hÃ³a</small>
        </div>
      </div>
    </div>
  </div>
  <input type="hidden" id="usernamelogin" th:value="${usernamelogin}"/>
  <!-- Section to display active users -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">ğŸ‘¥ NgÆ°á»i dÃ¹ng Ä‘ang online <span id="connectionStatus" class="badge bg-danger">Disconnected</span></h5>
          <div id="activeUsersContainer"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const socket = new SockJS('/ws');
  const stompClient = Stomp.over(socket);
  const username = document.getElementById('usernamelogin').value;
  
  stompClient.connect({}, function (frame) {
    console.log('Connected: ' + frame);
    document.getElementById('connectionStatus').textContent = 'Connected';
    document.getElementById('connectionStatus').className = 'badge bg-success';

    stompClient.subscribe('/topic/activeUsers', function (message) {
      const activeUsers = JSON.parse(message.body);
      updateActiveUsersList(activeUsers);
    });

    fetch('/admin/accounts/api/active-users')
      .then(res => res.json())
      .then(data => updateActiveUsersList(data))
      .catch(() => {
        document.getElementById('activeUsersContainer').innerHTML = `
          <div class="alert alert-danger">KhÃ´ng thá»ƒ táº£i danh sÃ¡ch ngÆ°á»i dÃ¹ng.</div>`;
      });
  });

  function updateActiveUsersList(users) {
    const container = document.getElementById('activeUsersContainer');
    container.innerHTML = '';

    const entries = Object.entries(users);
    if (entries.length === 0) {
      container.innerHTML = `<p class="text-muted">KhÃ´ng cÃ³ ngÆ°á»i dÃ¹ng nÃ o Ä‘ang online.</p>`;
      return;
    }

    const row = document.createElement('div');
    row.className = 'row';

    entries.forEach(([username, info]) => {
      const isOnline = info.online;
      const time = new Date(info.time).toLocaleString('vi-VN');
      const statusText = isOnline ? 'Thao tÃ¡c gáº§n nháº¥t' : 'Rá»i lÃºc';

      const col = document.createElement('div');
      col.className = 'col-md-3 mb-3';
      col.innerHTML = `
        <div class="card shadow-sm border-0 ${isOnline ? 'bg-success-subtle' : 'bg-secondary-subtle'}">
          <div class="card-body text-center">
            <h5 class="card-title">${username}</h5>
            <span class="badge bg-${isOnline ? 'success' : 'secondary'}">
              ${isOnline ? 'ğŸŸ¢ Online' : 'âš« Offline'}
            </span>
            <p class="mt-2 mb-0 text-muted">
              ${statusText}:<br><strong>${time}</strong>
            </p>
          </div>
        </div>
      `;
      row.appendChild(col);
    });

    container.appendChild(row);
  }

  window.onbeforeunload = function () {
    stompClient.disconnect();
  };
</script>
</div>

</body>
</html>
