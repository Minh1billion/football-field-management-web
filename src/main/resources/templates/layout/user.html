<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="layout(content)">
<head>
    <meta charset="UTF-8">
    <title>User Panel</title>
    <!-- Include SockJS and STOMP libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" th:href="@{/user/user-home}">âš½ User Panel</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#userNavbar"
                aria-controls="userNavbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="userNavbar">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/user-home}">ğŸ  Trang chá»§</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/bookings}">âš½ Äáº·t sÃ¢n</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/rentals}">ğŸ‘• ThuÃª Ä‘á»“</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/sales}">ğŸ‘• Mua Ä‘á»“</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/orders}">ğŸ’³ ÄÆ¡n hÃ ng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/reviews}">ğŸ’¬ ÄÃ¡nh giÃ¡</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/rewards}">ğŸ… Äiá»ƒm thÆ°á»Ÿng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/notifications}">ğŸ”” ThÃ´ng bÃ¡o</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/profile}">ğŸ‘¤ Há»“ sÆ¡</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-warning fw-semibold" th:href="@{/logout}">ğŸšª ÄÄƒng xuáº¥t</a>
                </li>
            </ul>
        </div>
        
        <input type="hidden" id="usernamelogin" th:value="${usernamelogin}"/>
    </div>
</nav>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Get username from Thymeleaf model
    const username = document.getElementById('usernamelogin').value;
    console.log('Username from model:', username); // Debug giÃ¡ trá»‹ username

    // Initialize WebSocket connection
    const socket = new SockJS('/ws'); // Connect to WebSocket endpoint
    const stompClient = Stomp.over(socket);

    // Connect with username in headers
    stompClient.connect({ username: username }, function (frame) {
        console.log('Connected: ' + frame);

        // Subscribe to /topic/activeUsers to receive active users list
        stompClient.subscribe('/topic/activeUsers', function (message) {
            const activeUsers = JSON.parse(message.body); // Parse the received JSON
            updateActiveUsersList(activeUsers); // Update UI with active users
        });
    }, function (error) {
        console.error('WebSocket error: ', error);
    });

    // Function to update the active users list in the UI
    function updateActiveUsersList(users) {
        const listElement = document.getElementById('activeUsersList');
        listElement.innerHTML = ''; // Clear existing list
        users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = user;
            listElement.appendChild(li);
        });
    }

    // Handle window close to ensure proper disconnection
    window.onbeforeunload = function () {
        stompClient.disconnect();
    };
</script>
<div class="content p-4" th:insert="${content}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>