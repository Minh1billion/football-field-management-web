<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{layout/admin :: layout(~{::content})}">
<head>
<meta charset="UTF-8" />
<title>üëë Admin Chat H·ªó tr·ª£ kh√°ch h√†ng</title>
<style>
</style>
</head>
<body>
	<div th:fragment="content" style="
        display: flex;
        justify-content: center;   /* canh gi·ªØa theo chi·ªÅu ngang */
        align-items: center;       /* canh gi·ªØa theo chi·ªÅu d·ªçc */
        height: calc(100vh - 80px); /* tr·ª´ chi·ªÅu cao navbar n·∫øu c√≥ */
        text-align: center;
     ">
		<div class="chat-wrapper">
			<div class="chat-header">üëë H·ªó tr·ª£ kh√°ch h√†ng (Admin)</div>
			<div class="chat-body">
				<div class="user-select-container mb-3">
					<label>üìã Ch·ªçn ng∆∞·ªùi d√πng:</label> <select id="userSelect">
						<option value="">-- Ch·ªçn ng∆∞·ªùi d√πng --</option>
					</select>
				</div>

				<div id="chatBox">
					<div class="placeholder-text">
						<i class="bi bi-chat-dots"></i> Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o
					</div>
				</div>

				<div class="chat-controls">
					<input type="text" id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
					<button id="sendBtn">
						<i class="bi bi-send-fill"></i> G·ª≠i
					</button>
				</div>
			</div>
		</div>

		<!-- SocketJS + STOMP -->
		<script
			src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

		<script>
            let stompClient;
            const currentUser = "ADMIN";
            let selectedUser = null;
            const autoResponse = {};

            function connect() {
                const socket = new SockJS("/ws");
                stompClient = Stomp.over(socket);
                stompClient.connect({}, () => {
                    console.log("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng");

                    // Nh·∫≠n tin nh·∫Øn
                    stompClient.subscribe(`/topic/messages/${currentUser}`, (msg) => {
                        const message = JSON.parse(msg.body);
                        showMessage(message);

                        // üëá N·∫øu l√† tin nh·∫Øn t·ª´ user => g·ª≠i ph·∫£n h·ªìi t·ª± ƒë·ªông
                        if (message.sender !== currentUser) {
                            handleAutoReply(message);
                        }
                    });

                    // Nh·∫≠n th√¥ng b√°o thu h·ªìi
                    stompClient.subscribe(`/topic/recall/${currentUser}`, (msg) => {
                        const recalledId = JSON.parse(msg.body);
                        markAsRecalled(recalledId);
                    });

                    loadUsers();
                }, (error) => {
                    console.error("‚ùå WebSocket connection error:", error);
                });
            }

            function loadUsers() {
                fetch("/user/chat/api/accounts")
                    .then(res => res.json())
                    .then(users => {
                        const select = document.getElementById("userSelect");
                        select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi d√πng --</option>';
                        users.forEach(u => {
                            if (u.username !== currentUser) {
                                const opt = document.createElement("option");
                                opt.value = u.username;
                                opt.textContent = u.username;
                                select.appendChild(opt);
                            }
                        });
                    })
                    .catch(err => console.error("‚ùå L·ªói t·∫£i user:", err));
            }

            document.getElementById("userSelect").addEventListener("change", (e) => {
                selectedUser = e.target.value;
                const chatBox = document.getElementById("chatBox");
                if (selectedUser) {
                    chatBox.innerHTML = `<div class="placeholder-text"><i class="bi bi-chat-dots"></i> ƒêang chat v·ªõi ${selectedUser}</div>`;
                    loadHistory(selectedUser);
                } else {
                    chatBox.innerHTML = `<div class="placeholder-text"><i class="bi bi-chat-dots"></i> Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</div>`;
                }
            });

            document.getElementById("sendBtn").addEventListener("click", () => {
                const content = document.getElementById("msgInput").value.trim();
                if (!content || !selectedUser) return;

                const message = {
                    sender: currentUser,
                    receiver: selectedUser,
                    content: content,
                    timestamp: new Date().toISOString()
                };

                stompClient.send("/app/user/chat", {}, JSON.stringify(message));
                document.getElementById("msgInput").value = "";
            });

            // üëá T·ª± ƒë·ªông ph·∫£n h·ªìi tin nh·∫Øn user
            function handleAutoReply(msg) {
                const user = msg.sender;
                const text = msg.content.trim();

                // N·∫øu ƒë√¢y l√† tin ƒë·∫ßu ti√™n c·ªßa user -> g·ª≠i menu tr·ª£ gi√∫p
                if (!autoResponse[user]) {
                    autoResponse[user] = true;
                    showHelpMenu(user);
                } 
                // N·∫øu user nh·∫≠p 0 => hi·ªán l·∫°i danh s√°ch h·ªó tr·ª£
                else if (text === "0") {
                    showHelpMenu(user);
                } 
                // N·∫øu user nh·∫≠p 1 => ph·∫£n h·ªìi t·∫°m th·ªùi
                else if (text === "2") {
                    sendAutoMessage(user, "Vui l√≤ng ch·ªù, Admin s·∫Ω h·ªó tr·ª£ b·∫°n ngay. ü§ù");
                }
                else if (text === "1") {
                		showHelpMenu1(user);
                    
                    
                }
            }

            // G·ª≠i danh s√°ch h·ªó tr·ª£
            function sleep(ms) {
			    return new Promise(resolve => setTimeout(resolve, ms));
			}
			
			async function showHelpMenu1(user) {
			    const messages = [
			    	"H·ªá th·ªëng ƒëang truy xu·∫•t d·ªØ li·ªáu ! üèüÔ∏è",
			    	"Hi·ªán t·∫°i ch∆∞a h·ªó tr·ª£ t√≠nh nƒÉng n√†y ! üèüÔ∏è"
			    ];
			
			    for (const msg of messages) {
			        sendAutoMessage(user, msg);
			        await sleep(1000); // ch·ªù 0.5s m·ªõi g·ª≠i ti·∫øp
			    }
			}
			
			async function showHelpMenu(user) {
			    const messages = [
			        "B·∫°n c·∫ßn gi√∫p ƒë·ª° g√¨ ?",
			        "0Ô∏è‚É£ : Hi·ªán l·∫°i danh s√°ch h·ªó tr·ª£",
			        "1Ô∏è‚É£ : C·∫ßn t√¨m s√¢n li√™n h·ªá ng∆∞·ªùi ƒë√£ ƒë·∫∑t s√¢n kh√°c ?",
			        "2Ô∏è‚É£ : Kh√°c ?"
			    ];
			
			    for (const msg of messages) {
			        sendAutoMessage(user, msg);
			        await sleep(500); // ch·ªù 0.5s m·ªõi g·ª≠i ti·∫øp
			    }
			}

            // G·ª≠i tin nh·∫Øn t·ª± ƒë·ªông t·ª´ Admin
            function sendAutoMessage(to, text) {
			    if (!selectedUser || selectedUser !== to) {
			        // Ch·ªçn ng∆∞·ªùi d√πng n·∫øu ch∆∞a ch·ªçn ho·∫∑c kh√°c
			        const userSelect = document.getElementById("userSelect");
			        userSelect.value = to;
			        selectedUser = to;
			        const chatBox = document.getElementById("chatBox");
			        chatBox.innerHTML = `<div class="placeholder-text"><i class="bi bi-chat-dots"></i> ƒêang chat v·ªõi ${to}</div>`;
			        loadHistory(to);
			    }
			
			    // ƒêi·ªÅn text v√†o khung input
			    const msgInput = document.getElementById("msgInput");
			    msgInput.value = text;
			
			    // "B·∫•m n√∫t g·ª≠i" b·∫±ng code
			    document.getElementById("sendBtn").click();
			}

            // Hi·ªÉn th·ªã tin nh·∫Øn
            function showMessage(m) {
                const chatBox = document.getElementById("chatBox");
                if (m.sender !== selectedUser && m.receiver !== selectedUser) return;

                const div = document.createElement("div");
                const isAdmin = m.sender === currentUser;
                div.classList.add("msg", isAdmin ? "admin" : "user");
                div.setAttribute("data-id", m.id);

                const header = document.createElement("div");
                header.classList.add("msg-header");
                header.innerHTML = `<span>${m.sender}</span><span class="msg-timestamp">${formatTimestamp(m.timestamp)}</span>`;

                const content = document.createElement("div");
                content.classList.add("msg-content");

                if (m.content === "@@@##") {
                    content.textContent = "üïì Tin nh·∫Øn ƒë√£ thu h·ªìi";
                    content.classList.add("recalled-msg");
                } else {
                    content.textContent = m.content;
                }

                div.appendChild(header);
                div.appendChild(content);
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function markAsRecalled(messageId) {
                const chatBox = document.getElementById("chatBox");
                const msgDiv = chatBox.querySelector(`[data-id='${messageId}']`);
                if (msgDiv) {
                    const content = msgDiv.querySelector(".msg-content");
                    content.textContent = "üïì Tin nh·∫Øn ƒë√£ thu h·ªìi";
                    content.classList.add("recalled-msg");
                }
            }

            function formatTimestamp(timestamp) {
                if (!timestamp) return "";
                const date = new Date(timestamp);
                return date.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });
            }

            function loadHistory(target) {
                fetch(`/user/chat/history/${target}`)
                    .then(res => res.json())
                    .then(data => {
                        const chatBox = document.getElementById("chatBox");
                        chatBox.innerHTML = "";
                        data.forEach(m => showMessage(m));
                    })
                    .catch(err => console.error("‚ùå L·ªói t·∫£i l·ªãch s·ª≠:", err));
            }

            connect();
        </script>
	</div>
</body>
</html>