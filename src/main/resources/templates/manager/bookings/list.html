<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/manager :: layout(~{::content})}">
<head>
    <title>Danh s√°ch ƒë·∫∑t s√°n</title>
    <style>
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .action-buttons form {
            margin: 0;
        }
        .table-responsive {
            background: white;
        }
        .badge {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
<div th:fragment="content">
    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="text-primary">üìã Danh s√°ch ƒë·∫∑t s√¢n</h2>
        </div>

        <div class="table-responsive shadow-sm rounded">
            <table class="table table-striped align-middle mb-0">
                <thead class="table-primary">
                <tr>
                    <th>M√£ ƒë·∫∑t</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>S√¢n</th>
                    <th>Th·ªùi gian</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thanh to√°n</th>
                    <th class="text-center" style="min-width: 200px;">Thao t√°c</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="b : ${bookings}">
                    <td>
                        <strong th:text="${b.bookingCode}"></strong>
                    </td>
                    <td th:text="${b.customer != null ? b.customer.fullName : 'N/A'}"></td>
                    <td th:text="${b.field != null ? b.field.name : 'N/A'}"></td>

                    <td>
                        <small th:if="${b.startTime != null && b.endTime != null}">
                            <div th:text="${#temporals.format(b.startTime, 'dd/MM/yyyy')}"></div>
                            <div class="text-muted">
                                <span th:text="${#temporals.format(b.startTime, 'HH:mm')}"></span>
                                -
                                <span th:text="${#temporals.format(b.endTime, 'HH:mm')}"></span>
                            </div>
                        </small>
                    </td>

                    <td>
                        <strong class="text-success" th:text="${#numbers.formatDecimal(b.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></strong>
                    </td>

                    <td>
                        <span class="badge"
                              th:text="${b.status}"
                              th:classappend="${
                                  b.status.name() == 'PENDING'     ? ' bg-warning text-dark' :
                                  (b.status.name() == 'CONFIRMED'  ? ' bg-success' :
                                  (b.status.name() == 'CANCELLED'  ? ' bg-danger'  :
                                  (b.status.name() == 'COMPLETED'  ? ' bg-info text-dark' : ' bg-secondary')))
                              }">
                        </span>
                    </td>

                    <td>
                        <span th:if="${b.payment != null && b.payment.status != null}"
                              class="badge"
                              th:classappend="${
                                  b.payment.status.name() == 'PENDING' ? 'bg-warning text-dark' :
                                  (b.payment.status.name() == 'COMPLETED' ? 'bg-success' :
                                  (b.payment.status.name() == 'PAID' ? 'bg-success' :
                                  (b.payment.status.name() == 'CANCELLED' ? 'bg-danger' : 'bg-secondary')))
                              }"
                              th:text="${b.payment.status}">
                        </span>
                        <span th:if="${b.payment == null || b.payment.status == null}"
                              class="badge bg-secondary">
                            N/A
                        </span>
                    </td>

                    <td>
                        <div class="action-buttons">
                            <!-- ‚úÖ X√ÅC NH·∫¨N - Ch·ªâ hi·ªán khi PENDING -->
                            <form th:if="${b.status.name() == 'PENDING'}"
                                  th:action="@{|/manager/bookings/${b.id}/confirm|}"
                                  method="post">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    ‚úÖ X√°c nh·∫≠n
                                </button>
                            </form>

                            <!-- üèÅ HO√ÄN T·∫§T - Hi·ªán khi CONFIRMED v√† ƒë√£ thanh to√°n -->
                            <form th:if="${
                                        b.status.name() == 'CONFIRMED'
                                        and (
                                            (b.payment != null
                                                and b.payment.status != null
                                                and (b.payment.status.name() == 'COMPLETED' or b.payment.status.name() == 'PAID'))
                                            or (b.payment != null
                                                and b.payment.paymentMethod != null
                                                and (b.payment.paymentMethod.name() == 'CASH' or b.payment.paymentMethod.name() == 'COD')
                                                and b.payment.status != null
                                                and b.payment.status.name() == 'PENDING')
                                        )
                                     }"
                                  th:action="@{|/manager/bookings/${b.id}/complete|}"
                                  method="post"
                                  onsubmit="return confirm('X√°c nh·∫≠n ho√†n t·∫•t ƒë·∫∑t s√¢n n√†y (kh√°ch h√†ng ƒë√£ s·ª≠ d·ª•ng xong)?');">
                                <button type="submit" class="btn btn-sm btn-success">
                                    üèÅ Ho√†n t·∫•t
                                </button>
                            </form>

                            <!-- ‚ö†Ô∏è CH·ªú THANH TO√ÅN - Hi·ªán khi CONFIRMED nh∆∞ng ch∆∞a thanh to√°n -->
                            <span th:if="${
                                        b.status.name() == 'CONFIRMED'
                                        and not (
                                            (b.payment != null
                                                and b.payment.status != null
                                                and (b.payment.status.name() == 'COMPLETED' or b.payment.status.name() == 'PAID'))
                                            or (b.payment != null
                                                and b.payment.paymentMethod != null
                                                and (b.payment.paymentMethod.name() == 'CASH' or b.payment.paymentMethod.name() == 'COD')
                                                and b.payment.status != null
                                                and b.payment.status.name() == 'PENDING')
                                        )
                                     }"
                                  class="badge bg-warning text-dark">
                                ‚ö†Ô∏è Ch·ªù thanh to√°n
                            </span>

                            <!-- ‚ùå H·ª¶Y - Hi·ªán khi PENDING ho·∫∑c CONFIRMED -->
                            <form th:if="${b.status.name() == 'PENDING' or b.status.name() == 'CONFIRMED'}"
                                  th:action="@{|/manager/bookings/${b.id}/cancel|}"
                                  method="post"
                                  onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë·∫∑t s√¢n n√†y kh√¥ng?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    ‚ùå H·ªßy
                                </button>
                            </form>

                            <!-- üëÅÔ∏è XEM CHI TI·∫æT -->
                            <a th:href="@{|/manager/bookings/${b.id}|}"
                               class="btn btn-sm btn-outline-secondary">
                                üëÅÔ∏è Chi ti·∫øt
                            </a>
                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(bookings)}">
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <div>Kh√¥ng c√≥ ƒë·∫∑t s√¢n n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Legend -->
        <div class="mt-3">
            <small class="text-muted">
                <strong>Quy tr√¨nh:</strong>
                PENDING ‚Üí X√°c nh·∫≠n ‚Üí CONFIRMED (ƒë√£ kh√≥a) ‚Üí Ho√†n t·∫•t ‚Üí COMPLETED
            </small>
        </div>
    </div>
</div>
</body>
</html>