<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/admin :: layout(~{::content})}">
<head>
  <meta charset="UTF-8">
  <title>Thống kê giao dịch</title>
</head>
<body>
<div th:fragment="content" class="container mt-4">

  <!-- Header + Lọc năm -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Thống kê giao dịch</h2>
    <form th:action="@{/admin/payment}" method="get" class="d-flex gap-2">
      <select name="year" class="form-select w-auto" onchange="this.form.submit()">
        <option value="">-- Chọn năm --</option>
        <option th:each="y : ${availableYears}" 
                th:value="${y}" 
                th:text="${y}" 
                th:selected="${y == selectedYear}"></option>
      </select>
    </form>
  </div>

  <!-- Tổng quan -->
  <div class="row text-center mb-4 g-3">
    <div class="col-md-3">
      <div class="card stats-card border-primary">
        <div class="card-body">
          <h5 class="text-primary">Đặt sân</h5>
          <h3 th:text="${totalBookings}">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card border-success">
        <div class="card-body">
          <h5 class="text-success">Mua hàng</h5>
          <h3 th:text="${totalOrders}">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card border-warning">
        <div class="card-body">
          <h5 class="text-warning">Thuê dịch vụ</h5>
          <h3 th:text="${totalRentals}">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card border-danger">
        <div class="card-body">
          <h5 class="text-danger">Tổng doanh thu</h5>
          <h3 th:text="${#numbers.formatDecimal(totalAmount, 0, 'POINT', 0, 'COMMA')} + ' đ'">0 đ</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Biểu đồ -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <h5 class="text-center mb-3">Số lượng giao dịch theo tháng</h5>
      <div class="chart-container">
        <canvas id="chartCount"></canvas>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <h5 class="text-center mb-3">Doanh thu theo tháng</h5>
      <div class="chart-container">
        <canvas id="chartRevenue"></canvas>
      </div>
    </div>
  </div>

  <!-- Nút xuất Excel -->
  <div class="text-end mb-3">
    <a th:href="@{/admin/payment/export-excel(year=${selectedYear})}" 
       class="btn btn-success btn-lg" 
       th:disabled="${payments == null or #lists.isEmpty(payments)}">
      Xuất Excel
    </a>
  </div>

  <!-- Bảng dữ liệu -->
  <div class="table-responsive">
    <table class="table table-hover table-bordered align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>#</th>
          <th>Khách hàng</th>
          <th>Loại</th>
          <th>Hình thức</th>
          <th>Trạng thái</th>
          <th>Số tiền</th>
          <th>Ngày tạo</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="p, i : ${payments}">
          <td th:text="${i.count}" class="text-center"></td>
          <td th:text="${p.customerFullName} ?: 'Khách lẻ'"></td>

          <!-- LOẠI: Booking, Order, Rental -->
          <td>
            <span class="badge"
                  th:class="${p.type == 'Booking' ? 'bg-primary' : 
                             p.type == 'Order' ? 'bg-success' : 'bg-warning'}"
                  th:text="${p.type}"></span>
          </td>

          <td th:text="${p.paymentType} ?: '—'"></td>

          <!-- TRẠNG THÁI: PENDING, COMPLETED, FAILED, REFUNDED, CANCELLED -->
          <td>
            <span class="badge"
                  th:class="${p.paymentStatus == 'COMPLETED' ? 'bg-success' :
                             p.paymentStatus == 'PENDING' ? 'bg-warning' :
                             p.paymentStatus == 'REFUNDED' ? 'bg-info' :
                             p.paymentStatus == 'CANCELLED' ? 'bg-secondary' :
                             'bg-danger'}"
                  th:text="${p.paymentStatus}"></span>
          </td>

          <td th:text="${#numbers.formatDecimal(p.amount ?: 0, 0, 'POINT', 0, 'COMMA')} + ' đ'" class="text-end"></td>
          <td th:text="${#temporals.format(p.createdAt, 'dd/MM/yyyy HH:mm')}" class="text-center"></td>
        </tr>

        <!-- Không có dữ liệu -->
        <tr th:if="${payments == null or #lists.isEmpty(payments)}">
          <td colspan="7" class="text-center text-muted py-4">
            Không có giao dịch nào trong năm <span th:text="${selectedYear}"></span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- BIỂU ĐỒ JS -->
  <script th:inline="javascript">
    const monthLabels = /*[[${monthLabels}]]*/ [];
    const countValues = /*[[${countValues}]]*/ [];
    const revenueValues = /*[[${revenueValues}]]*/ [];

    const hasData = countValues.some(v => v > 0) || revenueValues.some(v => v > 0);

    function createChart(ctx, type, label, data, bgColor, borderColor) {
      return new Chart(ctx, {
        type: type,
        data: {
          labels: monthLabels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: bgColor,
            borderColor: borderColor || bgColor,
            borderWidth: 2,
            tension: 0.3,
            fill: type === 'line'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  if (context.datasetIndex === 1) { // Doanh thu
                    return label + ': ' + value.toLocaleString('vi-VN') + ' đ';
                  }
                  return label + ': ' + value;
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // Vẽ biểu đồ
    if (hasData) {
      createChart(
        document.getElementById('chartCount').getContext('2d'),
        'line',
        'Số lượng giao dịch',
        countValues,
        'rgba(54, 162, 235, 0.2)',
        'rgb(54, 162, 235)'
      );

      createChart(
        document.getElementById('chartRevenue').getContext('2d'),
        'bar',
        'Doanh thu (VNĐ)',
        revenueValues,
        'rgba(75, 192, 192, 0.6)',
        'rgb(75, 192, 192)'
      );
    } else {
      ['chartCount', 'chartRevenue'].forEach(id => {
        const container = document.querySelector('#' + id).parentElement;
        container.innerHTML = '<div class="empty-chart">Không có dữ liệu</div>';
      });
    }
  </script>

</div>
</body>
</html>