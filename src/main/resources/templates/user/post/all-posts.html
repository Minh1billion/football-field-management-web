<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>B·∫£ng tin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    .post-container { min-height: 300px; }
    .comment-list { max-height: 400px; overflow-y: auto; }
    .comment-section { border-left: 1px solid #dee2e6; padding-left: 15px; }
    .like-btn.liked { background-color: #0d6efd; color: white; border-color: #0d6efd; }
    .spinner-border-sm { width: 1rem; height: 1rem; border-width: 0.15em; }
    .warning-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 500px; width: 90%; }
  </style>
</head>

<body>
<h3 class="mb-4 text-primary text-center fw-bold">üì∞ B·∫£ng tin</h3>

<div class="d-flex justify-content-end mb-3">
  <select id="filterTime" class="form-select w-auto">
    <option value="all">T·∫•t c·∫£</option>
    <option value="hour">1 gi·ªù qua</option>
    <option value="day">1 ng√†y qua</option>
    <option value="week">1 tu·∫ßn qua</option>
    <option value="month">1 th√°ng qua</option>
    <option value="year">1 nƒÉm qua</option>
  </select>
</div>
<button class="btn btn-primary mb-3" onclick="window.location.href='/user/post'">
  ‚¨ÖÔ∏è Quay l·∫°i trang ƒëƒÉng b√†i
</button>

<div id="postList" class="d-flex flex-column gap-3">
  <div th:each="p : ${posts}" class="card" th:data-createdat="${p.createdAt}" th:data-post-id="${p.id}">
    <div class="card-body">
      <div class="row post-container">
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="avatar"
                 class="rounded-circle me-2" style="width:40px;height:40px;">
            <div>
              <h6 class="mb-0 fw-bold">[[${p.author}]]</h6>
              <small class="text-muted">üïí [[${#temporals.format(p.createdAt, 'HH:mm dd/MM/yyyy')}]]</small>
            </div>
          </div>

          <div th:if="${p.imageUrl}" class="mb-2">
            <img th:src="${p.imageUrl}" alt="·∫¢nh b√†i ƒëƒÉng" class="img-fluid rounded">
          </div>

          <p>[[${p.content}]]</p>

          <div class="d-flex gap-2 mb-2">
            <button type="button"
                    class="btn btn-outline-primary btn-sm like-btn"
                    th:classappend="${p.isLikedBy(usernamelogin)} ? 'liked' : ''"
                    th:data-is-liked="${p.isLikedBy(usernamelogin)}">
              üëç <span class="like-text" th:text="${p.isLikedBy(usernamelogin)} ? 'ƒê√£ th√≠ch' : 'Th√≠ch'">Th√≠ch</span>
              (<span class="like-count">[[${p.likes}]]</span>)
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm">
              üí¨ B√¨nh lu·∫≠n (<span class="comment-count">[[${#lists.size(p.comments)}]]</span>)
            </button>
          </div>
        </div>

        <div class="col-md-6 comment-section">
          <form class="comment-form mb-3" method="post">
            <div class="input-group">
              <input type="text" name="content" class="form-control" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required>
              <button type="submit" class="btn btn-success">
                <span class="submit-text">G·ª≠i</span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </form>

          <div class="comment-list">
            <div th:each="c : ${p.comments}" class="mb-2 p-2 border rounded comment-item bg-light">
              <div class="d-flex justify-content-between">
                <strong>[[${c.author}]]</strong>
                <small class="text-muted">[[${#temporals.format(c.createdAt, 'HH:mm dd/MM/yyyy')}]]</small>
              </div>
              <div>[[${c.content}]]</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="usernamelogin" th:value="${usernamelogin}"/>

<!-- Modal c·∫£nh b√°o -->
<div id="warningModal" class="d-none">
  <div class="modal-backdrop show"></div>
  <div class="card warning-modal shadow-lg">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0">‚ö†Ô∏è C·∫£nh b√°o n·ªôi dung vi ph·∫°m</h5>
    </div>
    <div class="card-body">
      <p class="mb-2"><strong>B√¨nh lu·∫≠n c·ªßa b·∫°n ch·ª©a n·ªôi dung kh√¥ng ph√π h·ª£p:</strong></p>
      <p id="warningReason" class="text-muted fst-italic"></p>
      <p class="mb-0 text-danger"><small>Vui l√≤ng ch·ªânh s·ª≠a v√† th·ª≠ l·∫°i.</small></p>
    </div>
    <div class="card-footer text-end">
      <button class="btn btn-secondary" onclick="closeWarningModal()">ƒê√≥ng</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let stompClient = null;

  function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
      document.querySelectorAll("#postList .card").forEach(post => {
        const postId = post.dataset.postId;
        stompClient.subscribe(`/topic/post/${postId}`, (message) => {
          const data = JSON.parse(message.body);
          updateUI(postId, data);
        });
      });
    }, (error) => console.error("WebSocket Error:", error));
  }

  function updateUI(postId, data) {
    const post = document.querySelector(`.card[data-post-id="${postId}"]`);
    if (!post) return;

    if (data.likes !== undefined) {
      const likeBtn = post.querySelector(".like-btn");
      const likeCountSpan = post.querySelector(".like-count");
      const likeText = post.querySelector(".like-text");
      if (likeCountSpan) likeCountSpan.textContent = data.likes;
      if (likeBtn && data.isLiked !== undefined) {
        likeBtn.classList.toggle("liked", data.isLiked);
        likeText.textContent = data.isLiked ? "ƒê√£ th√≠ch" : "Th√≠ch";
        likeBtn.dataset.isLiked = data.isLiked;
      }
    }

    if (data.author && data.content) {
      const commentList = post.querySelector(".comment-list");
      const newComment = document.createElement("div");
      newComment.classList.add("mb-2", "p-2", "border", "rounded", "comment-item", "bg-light");
      const now = new Date();
      const formattedTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
            + " " + now.toLocaleDateString('vi-VN');
      newComment.innerHTML = `
        <div class="d-flex justify-content-between">
          <strong>${data.author}</strong>
          <small class="text-muted">${formattedTime}</small>
        </div>
        <div>${data.content}</div>
      `;
      commentList.prepend(newComment);
      const commentCountSpan = post.querySelector(".comment-count");
      if (commentCountSpan) {
        commentCountSpan.textContent = parseInt(commentCountSpan.textContent) + 1;
      }
    }
  }

  // ‚úÖ H√†m ki·ªÉm tra n·ªôi dung v·ªõi Gemini API
  async function checkCommentWithGemini(content) {
    try {
      const response = await fetch('/user/api/check-comment-gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      });

      if (!response.ok) {
        console.error('API error:', response.status);
        return { flagged: false, reason: 'L·ªói k·∫øt n·ªëi API' };
      }

      const result = await response.json();
      if (result.error) {
        console.warn('Gemini API Error:', result.error);
        return { flagged: false, reason: 'Gemini API l·ªói' };
      }

      return {
        flagged: result.flagged === true || result.flagged === "true",
        reason: result.reason || 'N·ªôi dung ch·ª©a ng√¥n t·ª´ kh√¥ng ph√π h·ª£p.'
      };
    } catch (error) {
      console.error('L·ªói ki·ªÉm tra n·ªôi dung:', error);
      return { flagged: false, reason: 'L·ªói x·ª≠ l√Ω ph√≠a client' };
    }
  }

  function showWarningModal(reason) {
    const modal = document.getElementById('warningModal');
    document.getElementById('warningReason').textContent = reason || 'N·ªôi dung ch·ª©a ng√¥n t·ª´ kh√¥ng ph√π h·ª£p.';
    modal.classList.remove('d-none');
  }

  function closeWarningModal() {
    document.getElementById('warningModal').classList.add('d-none');
  }

  function setFormLoading(form, isLoading) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const submitText = submitBtn.querySelector('.submit-text');
    const spinner = submitBtn.querySelector('.spinner-border');
    const input = form.querySelector('input[name="content"]');
    submitBtn.disabled = input.disabled = isLoading;
    submitText.classList.toggle('d-none', isLoading);
    spinner.classList.toggle('d-none', !isLoading);
  }

  document.addEventListener("DOMContentLoaded", () => {
    connectWebSocket();

    document.querySelectorAll(".like-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const postId = btn.closest(".card").dataset.postId;
        const username = document.getElementById("usernamelogin").value;
        stompClient.send(`/app/post/${postId}/like`, {}, JSON.stringify({ username }));
      });
    });

    document.querySelectorAll(".comment-form").forEach(form => {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const postId = form.closest(".card").dataset.postId;
        const username = document.getElementById("usernamelogin").value;
        const content = form.querySelector("input[name='content']").value.trim();
        if (!content) return;
        setFormLoading(form, true);

        const moderationResult = await checkCommentWithGemini(content);
        setFormLoading(form, false);

        if (moderationResult.flagged) {
          showWarningModal(moderationResult.reason);
          return;
        }

        stompClient.send(`/app/post/${postId}/comment`, {}, JSON.stringify({ content, author: username }));
        form.reset();
      });
    });

    document.getElementById("filterTime").addEventListener("change", function () {
      const now = new Date();
      const posts = document.querySelectorAll("#postList .card");
      posts.forEach(post => {
        const createdAt = new Date(post.dataset.createdat);
        const diffHours = (now - createdAt) / 1000 / 3600;
        let show = false;
        switch (this.value) {
          case "all": show = true; break;
          case "hour": show = diffHours <= 1; break;
          case "day": show = diffHours <= 24; break;
          case "week": show = diffHours <= 24 * 7; break;
          case "month": show = diffHours <= 24 * 30; break;
          case "year": show = diffHours <= 24 * 365; break;
        }
        post.style.display = show ? "block" : "none";
      });
    });
  });
</script>
</body>
</html>
