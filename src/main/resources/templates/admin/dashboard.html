<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/admin :: layout(~{::content})}">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
</head>
<body>
<div th:fragment="content">
  <h2 class="mb-4">📊 Tổng quan hệ thống</h2>
  <div class="row text-center mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">👥 Tổng tài khoản</h5>
          <h2 th:text="${totalAccounts ?: 0}">0</h2>
          <small>Tất cả tài khoản trong hệ thống</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">👤 Người dùng</h5>
          <h2 th:text="${totalUsers ?: 0}">0</h2>
          <small>Tài khoản USER</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-warning text-white">
        <div class="card-body">
          <h5 class="card-title">👨‍💼 Quản lý</h5>
          <h2 th:text="${totalManagers ?: 0}">0</h2>
          <small>Tài khoản MANAGER</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-danger text-white">
        <div class="card-body">
          <h5 class="card-title">👑 Quản trị</h5>
          <h2 th:text="${totalAdmins ?: 0}">0</h2>
          <small>Tài khoản ADMIN</small>
        </div>
      </div>
    </div>
  </div>
  <div class="row text-center mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">🏟️ Sân hoạt động</h5>
          <h2 th:text="${totalFields ?: 0}">0</h2>
          <small>Sân đang mở</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-secondary text-white">
        <div class="card-body">
          <h5 class="card-title">🏢 Tổng dịch vụ</h5>
          <h2 th:text="${totalServices ?: 0}">0</h2>
          <small>Tất cả dịch vụ</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">✅ TK hoạt động</h5>
          <h2 th:text="${activeAccounts ?: 0}">0</h2>
          <small>Tài khoản đang hoạt động</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-dark text-white">
        <div class="card-body">
          <h5 class="card-title">❌ TK bị khóa</h5>
          <h2 th:text="${inactiveAccounts ?: 0}">0</h2>
          <small>Tài khoản bị vô hiệu hóa</small>
        </div>
      </div>
    </div>
  </div>
  <input type="hidden" id="usernamelogin" th:value="${usernamelogin}"/>
  <!-- Section to display active users -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">👥 Người dùng đang online <span id="connectionStatus" class="badge bg-danger">Disconnected</span></h5>
          <div id="activeUsersContainer"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const socket = new SockJS('/ws');
  const stompClient = Stomp.over(socket);
  const username = document.getElementById('usernamelogin').value;
  
  stompClient.connect({}, function (frame) {
    console.log('Connected: ' + frame);
    document.getElementById('connectionStatus').textContent = 'Connected';
    document.getElementById('connectionStatus').className = 'badge bg-success';

    stompClient.subscribe('/topic/activeUsers', function (message) {
      const activeUsers = JSON.parse(message.body);
      updateActiveUsersList(activeUsers);
    });

    fetch('/admin/accounts/api/active-users')
      .then(res => res.json())
      .then(data => updateActiveUsersList(data))
      .catch(() => {
        document.getElementById('activeUsersContainer').innerHTML = `
          <div class="alert alert-danger">Không thể tải danh sách người dùng.</div>`;
      });
  });

  function updateActiveUsersList(users) {
    const container = document.getElementById('activeUsersContainer');
    container.innerHTML = '';

    const entries = Object.entries(users);
    if (entries.length === 0) {
      container.innerHTML = `<p class="text-muted">Không có người dùng nào đang online.</p>`;
      return;
    }

    const row = document.createElement('div');
    row.className = 'row';

    entries.forEach(([username, info]) => {
      const isOnline = info.online;
      const time = new Date(info.time).toLocaleString('vi-VN');
      const statusText = isOnline ? 'Thao tác gần nhất' : 'Rời lúc';

      const col = document.createElement('div');
      col.className = 'col-md-3 mb-3';
      col.innerHTML = `
        <div class="card shadow-sm border-0 ${isOnline ? 'bg-success-subtle' : 'bg-secondary-subtle'}">
          <div class="card-body text-center">
            <h5 class="card-title">${username}</h5>
            <span class="badge bg-${isOnline ? 'success' : 'secondary'}">
              ${isOnline ? '🟢 Online' : '⚫ Offline'}
            </span>
            <p class="mt-2 mb-0 text-muted">
              ${statusText}:<br><strong>${time}</strong>
            </p>
          </div>
        </div>
      `;
      row.appendChild(col);
    });

    container.appendChild(row);
  }

  window.onbeforeunload = function () {
    stompClient.disconnect();
  };
</script>
</div>

</body>
</html>
