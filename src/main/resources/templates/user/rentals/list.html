<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/user :: layout(~{::content})}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh Sách Đồ Thuê</title>
</head>
<body>
<div th:fragment="content">
  <div class="container mt-4">

    <!-- Thông báo nếu không có booking -->
    <div th:if="${myBookings.isEmpty()}" class="alert alert-info mb-4">
      <i class="bi bi-info-circle"></i>
      <strong>Lưu ý:</strong> Bạn chưa có booking nào đang hoạt động.
      <a th:href="@{/user/bookings/new}" class="alert-link">Đặt sân ngay</a> để có thể thêm đồ thuê vào booking.
    </div>

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">

      <!-- Lặp qua danh sách đồ thể thao -->
      <div class="col" th:each="wear : ${sportWears}">
        <div class="card h-100 shadow-sm border-0">
          <img th:src="${wear.imageUrl != null and !wear.imageUrl.isEmpty() ? wear.imageUrl : 'https://via.placeholder.com/250x250?text=No+Image'}"
               class="card-img-top"
               th:alt="${wear.name}"
               style="height: 250px; object-fit: cover;">

          <div class="card-body d-flex flex-column p-3">
            <h5 class="card-title text-truncate mb-1" th:text="${wear.name}">Tên sản phẩm</h5>
            <p class="card-subtitle mb-2 text-muted small" th:text="${wear.brand}">Thương hiệu</p>

            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge"
                    th:classappend="${wear.isAvailableForRent and wear.stockQuantity > 0} ? 'bg-success' : 'bg-danger'"
                    th:text="${wear.isAvailableForRent and wear.stockQuantity > 0} ? 'Sẵn sàng thuê' : 'Đã cho thuê/Hết hàng'">
                Trạng thái
              </span>
              <small class="text-uppercase border border-secondary px-2 rounded" th:text="${wear.size}">Size</small>
            </div>

            <h4 class="text-primary mt-auto fw-bold mb-2">
              <span th:text="${#numbers.formatDecimal(wear.rentalPricePerDay, 0, 'POINT', 2, 'COMMA')}">100.000</span>₫
              <span class="h6 text-muted">/ ngày</span>
            </h4>

            <div class="mt-2">
              <!-- Nút Thuê ngay -->
              <a th:href="@{/user/rentals/detail/{id}(id=${wear.id})}"
                 class="btn btn-primary w-100"
                 th:classappend="${wear.isAvailableForRent and wear.stockQuantity > 0} ? '' : ' disabled'">
                <i class="bi bi-cart-plus"></i> Thuê ngay
              </a>

              <!-- Form thêm vào Booking -->
              <div th:if="${!myBookings.isEmpty() and wear.isAvailableForRent and wear.stockQuantity > 0}">
                <form th:action="@{/user/rentals/add-to-booking}" method="post" class="mt-2">
                  <input type="hidden" th:name="sportWearId" th:value="${wear.id}" />

                  <!-- Chọn Booking với hiển thị rõ ràng hơn -->
                  <select name="bookingId" class="form-select form-select-sm mb-2" required>
                    <option value="" disabled selected>Chọn booking của bạn</option>
                    <option th:each="booking : ${myBookings}"
                            th:value="${booking.id}"
                            th:text="|${#temporals.format(booking.startTime, 'dd/MM/yyyy HH:mm')} - ${booking.field.name} (${booking.status == T(utescore.entity.Booking.BookingStatus).PENDING ? 'Chờ xác nhận' : 'Đã xác nhận'})|">
                      Booking
                    </option>
                  </select>

                  <!-- Chọn Số lượng -->
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">Số lượng</span>
                    <input type="number"
                           name="quantity"
                           class="form-control"
                           value="1"
                           min="1"
                           th:max="${wear.stockQuantity}"
                           required>
                  </div>

                  <!-- Nút Submit -->
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    <i class="bi bi-bookmark-plus"></i> Thêm vào Booking
                  </button>
                </form>
              </div>

              <!-- Thông báo nếu không có booking -->
              <div th:if="${myBookings.isEmpty()}" class="mt-2">
                <button type="button" class="btn btn-secondary btn-sm w-100" disabled>
                  <i class="bi bi-bookmark-x"></i> Chưa có booking
                </button>
                <small class="text-muted d-block text-center mt-1">
                  <a th:href="@{/user/bookings/new}">Đặt sân trước</a>
                </small>
              </div>
            </div>
          </div>

          <div class="card-footer bg-light p-2">
            <small class="text-muted d-block text-center">
              <strong>Loại:</strong> <span th:text="${wear.wearType}">JERSEY</span> |
              <strong>Còn:</strong> <span th:text="${wear.stockQuantity}">10</span>
            </small>
          </div>
        </div>
      </div>

      <!-- Khi danh sách rỗng -->
      <div th:if="${#lists.isEmpty(sportWears)}" class="col-12">
        <div class="alert alert-warning text-center">
          <i class="bi bi-inbox"></i>
          <p class="mb-0">Không tìm thấy đồ thể thao nào.</p>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>