<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>B·∫£ng tin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    .post-container {
      min-height: 300px; /* ƒê·∫£m b·∫£o chi·ªÅu cao t·ªëi thi·ªÉu cho b√†i vi·∫øt v√† b√¨nh lu·∫≠n */
    }
    .comment-list {
      max-height: 400px; /* Gi·ªõi h·∫°n chi·ªÅu cao danh s√°ch b√¨nh lu·∫≠n */
      overflow-y: auto; /* Th√™m thanh cu·ªôn n·∫øu b√¨nh lu·∫≠n qu√° d√†i */
    }
    .comment-section {
      border-left: 1px solid #dee2e6; /* ƒê∆∞·ªùng vi·ªÅn ph√¢n c√°ch gi·ªØa b√†i vi·∫øt v√† b√¨nh lu·∫≠n */
      padding-left: 15px;
    }
  </style>
</head>

<body>
  <h3 class="mb-4 text-primary text-center fw-bold">üì∞ B·∫£ng tin</h3>

  <!-- B·ªô l·ªçc th·ªùi gian -->
  <div class="d-flex justify-content-end mb-3">
    <select id="filterTime" class="form-select w-auto">
      <option value="all">T·∫•t c·∫£</option>
      <option value="hour">1 gi·ªù qua</option>
      <option value="day">1 ng√†y qua</option>
      <option value="week">1 tu·∫ßn qua</option>
      <option value="month">1 th√°ng qua</option>
      <option value="year">1 nƒÉm qua</option>
    </select>
  </div>

  <!-- Danh s√°ch b√†i ƒëƒÉng -->
  <div id="postList" class="d-flex flex-column gap-3">
    <div th:each="p : ${posts}" class="card" th:data-createdat="${p.createdAt}" th:data-post-id="${p.id}">
      <div class="card-body">
        <div class="row post-container">
          <!-- Ph·∫ßn b√†i vi·∫øt (50%) -->
          <div class="col-md-6">
            <!-- Header -->
            <div class="d-flex align-items-center mb-2">
              <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="avatar"
                   class="rounded-circle me-2" style="width:40px;height:40px;">
              <div>
                <h6 class="mb-0 fw-bold">[[${p.author}]]</h6>
                <small class="text-muted">üïí [[${#temporals.format(p.createdAt, 'HH:mm dd/MM/yyyy')}]]</small>
              </div>
            </div>

            <div th:if="${p.imageUrl}" class="mb-2">
              <img th:src="${p.imageUrl}" alt="·∫¢nh b√†i ƒëƒÉng" class="img-fluid rounded">
            </div>

            <p>[[${p.content}]]</p>

            <div class="d-flex gap-2 mb-2">
              <button type="button" class="btn btn-outline-primary btn-sm like-btn">
                üëç Th√≠ch (<span class="like-count">[[${p.likes}]]</span>)
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm">
                üí¨ B√¨nh lu·∫≠n (<span class="comment-count">[[${#lists.size(p.comments)}]]</span>)
              </button>
            </div>
          </div>

          <!-- Ph·∫ßn b√¨nh lu·∫≠n (50%) -->
          <div class="col-md-6 comment-section">
            <!-- üìù Form nh·∫≠p b√¨nh lu·∫≠n -->
            <form class="comment-form mb-3" method="post">
              <div class="input-group">
                <input type="text" name="content" class="form-control" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required>
                <button type="submit" class="btn btn-success">G·ª≠i</button>
              </div>
            </form>

            <!-- üí¨ Danh s√°ch b√¨nh lu·∫≠n -->
            <div class="comment-list">
              <div th:each="c : ${p.comments}" class="mb-2 p-2 border rounded comment-item bg-light">
                <div class="d-flex justify-content-between">
                  <strong>[[${c.author}]]</strong>
                  <small class="text-muted">[[${#temporals.format(c.createdAt, 'HH:mm dd/MM/yyyy')}]]</small>
                </div>
                <div>[[${c.content}]]</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="hidden" id="usernamelogin" th:value="${usernamelogin}"/>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let stompClient = null;

    function connectWebSocket() {
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);
      stompClient.connect({}, () => {
        document.querySelectorAll("#postList .card").forEach(post => {
          const postId = post.dataset.postId;
          stompClient.subscribe(`/topic/post/${postId}`, (message) => {
            const data = JSON.parse(message.body);
            updateUI(postId, data);
          });
        });
      }, (error) => {
        console.error("WebSocket Error:", error);
      });
    }

    // üß© C·∫≠p nh·∫≠t UI khi nh·∫≠n d·ªØ li·ªáu m·ªõi
    function updateUI(postId, data) {
      const post = document.querySelector(`.card[data-post-id="${postId}"]`);
      if (!post) return;

      // C·∫≠p nh·∫≠t Like
      if (data.likes !== undefined) {
        const likeCountSpan = post.querySelector(".like-count");
        if (likeCountSpan) likeCountSpan.textContent = data.likes;
      }

      // C·∫≠p nh·∫≠t B√¨nh lu·∫≠n
      if (data.author && data.content) {
        const commentList = post.querySelector(".comment-list");
        const newComment = document.createElement("div");
        newComment.classList.add("mb-2", "p-2", "border", "rounded", "comment-item", "bg-light");

        const now = new Date();
        const formattedTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
                              + " " + now.toLocaleDateString('vi-VN');

        newComment.innerHTML = `
          <div class="d-flex justify-content-between">
            <strong>${data.author}</strong>
            <small class="text-muted">${formattedTime}</small>
          </div>
          <div>${data.content}</div>
        `;

        // Th√™m b√¨nh lu·∫≠n m·ªõi ngay D∆Ø·ªöI form nh·∫≠p
        commentList.prepend(newComment);

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b√¨nh lu·∫≠n
        const commentCountSpan = post.querySelector(".comment-count");
        if (commentCountSpan) {
          const currentCount = parseInt(commentCountSpan.textContent.match(/\d+/)?.[0] || 0);
          commentCountSpan.textContent = currentCount + 1;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      connectWebSocket();

      // G·ª≠i Like
      document.querySelectorAll(".like-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const postId = btn.closest(".card").dataset.postId;
          stompClient.send(`/app/post/${postId}/like`, {}, {});
        });
      });

      // G·ª≠i Comment
      document.querySelectorAll(".comment-form").forEach(form => {
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const postId = form.closest(".card").dataset.postId;
          const username = document.getElementById("usernamelogin").value;
          const content = form.querySelector("input[name='content']").value;
          stompClient.send(`/app/post/${postId}/comment`, {}, JSON.stringify({ content, author: username }));
          form.reset();
        });
      });

      // B·ªô l·ªçc th·ªùi gian
      document.getElementById("filterTime").addEventListener("change", function () {
        const now = new Date();
        const value = this.value;
        const posts = document.querySelectorAll("#postList .card");

        posts.forEach(post => {
          const createdAt = new Date(post.dataset.createdat);
          const diffHours = (now - createdAt) / 1000 / 3600;
          let show = false;
          switch (value) {
            case "all": show = true; break;
            case "hour": show = diffHours <= 1; break;
            case "day": show = diffHours <= 24; break;
            case "week": show = diffHours <= 24 * 7; break;
            case "month": show = diffHours <= 24 * 30; break;
            case "year": show = diffHours <= 24 * 365; break;
          }
          post.style.display = show ? "block" : "none";
        });
      });
    });
  </script>
</body>
</html>