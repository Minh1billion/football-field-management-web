<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>B·∫£ng tin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    .post-container {
      min-height: 300px;
    }
    .comment-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .comment-section {
      border-left: 1px solid #dee2e6;
      padding-left: 15px;
    }
    /* Hi·ªáu ·ª©ng khi ƒë√£ like */
    .like-btn.liked {
      background-color: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
  </style>
</head>

<body>
<h3 class="mb-4 text-primary text-center fw-bold">üì∞ B·∫£ng tin</h3>

<div class="d-flex justify-content-end mb-3">
  <select id="filterTime" class="form-select w-auto">
    <option value="all">T·∫•t c·∫£</option>
    <option value="hour">1 gi·ªù qua</option>
    <option value="day">1 ng√†y qua</option>
    <option value="week">1 tu·∫ßn qua</option>
    <option value="month">1 th√°ng qua</option>
    <option value="year">1 nƒÉm qua</option>
  </select>
</div>
<button class="btn btn-primary mb-3" onclick="window.location.href='/user/post'">
  ‚¨ÖÔ∏è Quay l·∫°i trang ƒëƒÉng b√†i
</button>
<div id="postList" class="d-flex flex-column gap-3">
  <div th:each="p : ${posts}" class="card" th:data-createdat="${p.createdAt}" th:data-post-id="${p.id}">
    <div class="card-body">
      <div class="row post-container">
        <!-- Ph·∫ßn b√†i vi·∫øt (50%) -->
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="avatar"
                 class="rounded-circle me-2" style="width:40px;height:40px;">
            <div>
              <h6 class="mb-0 fw-bold">[[${p.author}]]</h6>
              <small class="text-muted">üïí [[${#temporals.format(p.createdAt, 'HH:mm dd/MM/yyyy')}]]</small>
            </div>
          </div>

          <div th:if="${p.imageUrl}" class="mb-2">
            <img th:src="${p.imageUrl}" alt="·∫¢nh b√†i ƒëƒÉng" class="img-fluid rounded">
          </div>

          <p>[[${p.content}]]</p>

          <div class="d-flex gap-2 mb-2">
            <!-- ‚úÖ Th√™m class 'liked' n·∫øu user ƒë√£ like -->
            <button type="button"
                    class="btn btn-outline-primary btn-sm like-btn"
                    th:classappend="${p.isLikedBy(usernamelogin)} ? 'liked' : ''"
                    th:data-is-liked="${p.isLikedBy(usernamelogin)}">
              üëç <span class="like-text" th:text="${p.isLikedBy(usernamelogin)} ? 'ƒê√£ th√≠ch' : 'Th√≠ch'">Th√≠ch</span>
              (<span class="like-count">[[${p.likes}]]</span>)
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm">
              üí¨ B√¨nh lu·∫≠n (<span class="comment-count">[[${#lists.size(p.comments)}]]</span>)
            </button>
          </div>
        </div>

        <!-- Ph·∫ßn b√¨nh lu·∫≠n (50%) -->
        <div class="col-md-6 comment-section">
          <form class="comment-form mb-3" method="post">
            <div class="input-group">
              <input type="text" name="content" class="form-control" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required>
              <button type="submit" class="btn btn-success">G·ª≠i</button>
            </div>
          </form>

          <div class="comment-list">
            <div th:each="c : ${p.comments}" class="mb-2 p-2 border rounded comment-item bg-light">
              <div class="d-flex justify-content-between">
                <strong>[[${c.author}]]</strong>
                <small class="text-muted">[[${#temporals.format(c.createdAt, 'HH:mm dd/MM/yyyy')}]]</small>
              </div>
              <div>[[${c.content}]]</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="usernamelogin" th:value="${usernamelogin}"/>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let stompClient = null;

  function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
      document.querySelectorAll("#postList .card").forEach(post => {
        const postId = post.dataset.postId;
        stompClient.subscribe(`/topic/post/${postId}`, (message) => {
          const data = JSON.parse(message.body);
          updateUI(postId, data);
        });
      });
    }, (error) => {
      console.error("WebSocket Error:", error);
    });
  }

  // ‚úÖ C·∫≠p nh·∫≠t UI khi nh·∫≠n d·ªØ li·ªáu m·ªõi
  function updateUI(postId, data) {
    const post = document.querySelector(`.card[data-post-id="${postId}"]`);
    if (!post) return;

    // ‚úÖ C·∫≠p nh·∫≠t Like v·ªõi tr·∫°ng th√°i toggle
    if (data.likes !== undefined) {
      const likeBtn = post.querySelector(".like-btn");
      const likeCountSpan = post.querySelector(".like-count");
      const likeText = post.querySelector(".like-text");

      if (likeCountSpan) likeCountSpan.textContent = data.likes;

      // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t like
      if (likeBtn && data.isLiked !== undefined) {
        if (data.isLiked) {
          likeBtn.classList.add("liked");
          if (likeText) likeText.textContent = "ƒê√£ th√≠ch";
        } else {
          likeBtn.classList.remove("liked");
          if (likeText) likeText.textContent = "Th√≠ch";
        }
        likeBtn.dataset.isLiked = data.isLiked;
      }
    }

    // C·∫≠p nh·∫≠t B√¨nh lu·∫≠n
    if (data.author && data.content) {
      const commentList = post.querySelector(".comment-list");
      const newComment = document.createElement("div");
      newComment.classList.add("mb-2", "p-2", "border", "rounded", "comment-item", "bg-light");

      const now = new Date();
      const formattedTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
              + " " + now.toLocaleDateString('vi-VN');

      newComment.innerHTML = `
          <div class="d-flex justify-content-between">
            <strong>${data.author}</strong>
            <small class="text-muted">${formattedTime}</small>
          </div>
          <div>${data.content}</div>
        `;

      commentList.prepend(newComment);

      const commentCountSpan = post.querySelector(".comment-count");
      if (commentCountSpan) {
        const currentCount = parseInt(commentCountSpan.textContent.match(/\d+/)?.[0] || 0);
        commentCountSpan.textContent = currentCount + 1;
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    connectWebSocket();

    // ‚úÖ G·ª≠i Toggle Like
    document.querySelectorAll(".like-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const postId = btn.closest(".card").dataset.postId;
        const username = document.getElementById("usernamelogin").value;

        // G·ª≠i request v·ªõi username
        stompClient.send(`/app/post/${postId}/like`, {}, JSON.stringify({ username }));
      });
    });

    // G·ª≠i Comment
    document.querySelectorAll(".comment-form").forEach(form => {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const postId = form.closest(".card").dataset.postId;
        const username = document.getElementById("usernamelogin").value;
        const content = form.querySelector("input[name='content']").value;
        stompClient.send(`/app/post/${postId}/comment`, {}, JSON.stringify({ content, author: username }));
        form.reset();
      });
    });

    // B·ªô l·ªçc th·ªùi gian
    document.getElementById("filterTime").addEventListener("change", function () {
      const now = new Date();
      const value = this.value;
      const posts = document.querySelectorAll("#postList .card");

      posts.forEach(post => {
        const createdAt = new Date(post.dataset.createdat);
        const diffHours = (now - createdAt) / 1000 / 3600;
        let show = false;
        switch (value) {
          case "all": show = true; break;
          case "hour": show = diffHours <= 1; break;
          case "day": show = diffHours <= 24; break;
          case "week": show = diffHours <= 24 * 7; break;
          case "month": show = diffHours <= 24 * 30; break;
          case "year": show = diffHours <= 24 * 365; break;
        }
        post.style.display = show ? "block" : "none";
      });
    });
  });
</script>
</body>
</html>